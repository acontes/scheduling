<?xml version="1.0" encoding="utf-8"?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xml:id="CommandLineInterface">
<info><title>The command line interface</title></info>
	<para>
			This part explains how to launch the ProActive Resource Manager and interact with it using command
			line interface (CLI). In order to use this interface the <emphasis role="italics">JAVA_HOME</emphasis> environment variable has to be
			defined.
	</para>
	<section xml:id="RM_start"><info><title>Launching the resource manager</title></info>
		<para>
			To start the resource manager, run the <emphasis>rm-start[.bat]</emphasis> or
			<emphasis>rm-start-clean[.bat]</emphasis>
			script in <literal>bin/[os]/</literal> directory. The second script drops all the data from
			data base used to store the history of RM. When launching the resource manager,
			it is possible to specify few arguments:
			<itemizedlist>
				<listitem> <para><emphasis>-ln</emphasis> or <emphasis>--localNodes</emphasis>,
				start the resource manager with 4 local nodes</para>
				</listitem>
				<listitem> <para><emphasis>-d</emphasis> or <emphasis>--deploy</emphasis>, followed by a list
				of GCM deployment files (GCMD, see below for GCM utilisation) deploys ProActive nodes described
				there.</para>
				</listitem>
				<listitem> <para><emphasis>-h</emphasis> or <emphasis>--help</emphasis> -
				prints the command line help.</para>
				</listitem>
			</itemizedlist>
		</para>
	</section>
	<section xml:id="rm_admin_console"><info><title>Interacting with the resource manager</title></info>
	<para><emphasis>rm-client[.bat]</emphasis>, in <literal>bin/[os]</literal> directory, provides a way to connect to the resource manager
	and manipulate it in command line mode. This scrips supports a bunch of options:
	</para>
	<programlisting><textobject><textdata fileref="code_snippets/admin/rm-client-help.txt"/></textobject></programlisting>
	<para>
			When new node source is created custom infrastructure or policy can be specified:
	</para>
	<itemizedlist>
		<listitem>
			<para>
					<emphasis role="italics">-infrastructure</emphasis> parameter allows to list or specify an infrastructure.
					In order to see the list of supported infrastructures run
			</para>
		</listitem>
	</itemizedlist>
	<programlisting><textobject><textdata fileref="code_snippets/admin/rm-client-infrastructure.txt"/></textobject></programlisting>

		<para>
			Choose the one you need and add the corresponding parameters to the command line.
		</para>
	<itemizedlist>
		<listitem>
			<para>
					<emphasis role="italics">-policy</emphasis> parameter allows to list or specify a policy. First see the list
					of available policies:
			</para>
		</listitem>
	</itemizedlist>

	<programlisting><textobject><textdata fileref="code_snippets/admin/rm-client-policy.txt"/></textobject></programlisting>
		<para>
			Then select the appropriate one and specify it in the command line. Example:
		</para>
		<screen>>rm-client -l admin -cn myns -infrastructure org.ow2.proactive.resourcemanager.nodesource.infrastructure.DefaultInfrastructureManager -policy org.ow2.proactive.resourcemanager.nodesource.policy.StaticPolicy</screen>

	<section xml:id="rm_admin_js_console"><info><title>Interactive mode</title></info>
	<para>
		Another way to interact with the resource manager is using the interactive mode of the
		controller. Interactive mode correspond to a JavaScript console, which is able to manage the resouce manager.
		To start it in this mode, just launch the <emphasis role="bold">bin/[os]/rm-client[.bat]</emphasis> command without any parameter.
		Once connected, type ? or help() to get the list of provided functions:
	</para>
		<screen> exMode(display,onDemand)        Change the way exceptions are displayed (if display is true, stacks are displayed - if onDemand is true, prompt before displaying stacks)
 addnode(nodeURL, nsName)        Add node to the given node source (parameters is a string representing the node URL to add and an optional string representing the node source in which to add the node)
 removenode(nodeURL,preempt)     Remove the given node (parameter is a string representing the node URL, node is removed immediately if second parameter is true)
 createns(nsName,infr,pol)       Create a new node source with specified name, infrastructure and policy (e.g. createns('myname', ['infrastrucure', 'param1', ...], ['policy', 'param1', ...]))
 removens(nsName,preempt)        Remove the given node source (parameter is a string representing the node source name to remove, node source is removed immediately if second parameter is true)
 listnodes()                     List every handled nodes
 listns()                        List every handled node sources
 listInfrastructures()           List supported infrastructures
 listPolicies()                  List available node sources policies
 shutdown(preempt)               Shutdown the Resource Manager (RM shutdown immediately if parameter is true)
 jmxinfo()                       Display some statistics provided by MBean
 exec(scriptFilePath)            Execute the content of the given script file (parameter is a string representing a script-file path)
 setLogsDir(logsDir)             Set the directory where the log are located, (default is RM_HOME/.logs
 viewlogs(nbLines)               View the last nbLines lines of the logs file, (default nbLines is 20)
 refreshPermissions()            Reload permissions policy file
 exit()                          Exits RM controller</screen>

	<section xml:id="rm_admin_js_console_script"><info><title>execute actions in a Java script file</title></info>
		<para>
			You can script a sequence of commands to send to Resource Manager in a javascript file:
		</para>
		<programlisting language="java">
/* set exec mode in order to not display stack trace, and not ask for either.*/
exMode(false,false);

/* remove a node source, preemptively */
removens("my_node_source",true);

/* create a new node source with GCMD and static nodes acquisition*/
createns("my_node_source", ['org.ow2.proactive.resourcemanager.nodesource.infrastructure.GCMInfrastructure', 'path_to_descriptor'], ['org.ow2.proactive.resourcemanager.nodesource.policy.StaticPolicy']);

/* wait for a while */
java.lang.Thread.sleep(10000);

/* check that deployment has succeed */
listnodes();
		</programlisting>
		<para>
		Then run this script by typing in interactive mode:
		</para>
		<screen>> exec("myScript.js");</screen>
		</section>
	</section>
	</section>
	<section xml:id="rm_JMX_admin"><info><title>JMX interface</title></info>
		<para>
			The JMX interface for remote management and monitoring provides information about the running ProActive Resource Manager and allows the user to modify its configuration.			 
			For more details about JMX concepts, please refer to official documentation about the <link xlink:href="http://java.sun.com/j2se/1.5.0/docs/guide/jmx/overview/architecture.html">JMX architecture</link>.  
		</para>
		<para>
			<figure xml:id="jmx_archi">
				<info>
					<title>Structure of the Resource Manager JMX interface</title>
				</info>
				<mediaobject>
					<imageobject>
						<imagedata scalefit="1" width="100%" contentdepth="100%"
							fileref="images/png/jmx_archi.png" format="PNG" />
					</imageobject>
				</mediaobject>
			</figure>
		</para>		
		<para>
			The following aspects (or services) of the Resource Manager are instrumented using MBeans that are managed through a JMX agent.
			<itemizedlist>
			<listitem>
				<para>
					The Resource Manager <emphasis>Core</emphasis> exposes various runtime information using the <emphasis>RuntimeDataMBean</emphasis> such as:
					<itemizedlist>
						<listitem>
							<para>The Resource Manager status</para>
						</listitem>						
						<listitem>
							<para>Available/Free/Busy/Down nodes count</para>
						</listitem>
						<listitem>
							<para>Average activity/inactivity percentage</para>
						</listitem>
					</itemizedlist>
				</para>
			</listitem>
			<listitem>
				<para>
					The <emphasis>Accounts Manager</emphasis> exposes accounting information using the <emphasis>MyAccountMBean</emphasis> and <emphasis>AllAccountsMBean</emphasis> such as:
					<itemizedlist>
						<listitem>
							<para>The used node time</para>
						</listitem>						
						<listitem>
							<para>The provided node time</para>
						</listitem>
						<listitem>
							<para>The provided node count</para>
						</listitem>
					</itemizedlist>
				</para>
			</listitem>
			<listitem>
				<para>
					Various management operations are exposed using the <emphasis>ManagementMBean</emphasis> such as:
					<itemizedlist>
						<listitem>
							<para>Setting the accounts refresh rate</para>
						</listitem>						
						<listitem>
							<para>Refresh all accounts</para>
						</listitem>
						<listitem>
							<para>Reload the permission policy file</para>
						</listitem>
					</itemizedlist>					
				</para>
			</listitem>
		</itemizedlist>			
		</para>
		<para>
			As shown on <xref linkend="jmx_archi"/>, the MBean server can be accessed by remote applications using one of the two available connectors:
			<itemizedlist>
				<listitem>
					<para>The standard solution based on Remote Method Invocation (RMI) protocol is the RMI Connector accessible at the following url:</para>
					<para>
						<literal>service:jmx:rmi:///jndi/rmi://</literal><emphasis>HOSTNAME</emphasis><literal>:</literal><emphasis>PORT</emphasis><literal>/JMXRMAgent</literal>
					</para>
					<para>where</para>
					<itemizedlist>
						<listitem>
							<para><emphasis>HOSTNAME</emphasis> is the hostname on which the RM is started</para>
						</listitem>
						<listitem>
							<para>
								<emphasis>PORT</emphasis> (5822 by default) is the port number on which the JMX RMI connector server
								has been started. It is defined by the property <emphasis>pa.rm.jmx.port</emphasis>.
							</para>
						</listitem>
					</itemizedlist>
				</listitem>
				<listitem>
					<para>The ProActive Remote Objects Connector provides ProActive protocol aware connector accessible at the following url:</para>									
					<para>
						<literal>service:jmx:ro:///jndi/</literal><emphasis>PA_PROTOCOL</emphasis><literal>://</literal><emphasis>HOSTNAME</emphasis><literal>:</literal><emphasis>PORT</emphasis><literal>/JMXRMAgent</literal>
					</para>
					<para>where</para>
					<itemizedlist>
						<listitem>
							<para><emphasis>PA_PROTOCOL</emphasis> is the protocol defined by the <emphasis>proactive.communication.protocol</emphasis> property</para>
						</listitem>
						<listitem>
							<para><emphasis>HOSTNAME</emphasis> is the hostname on which the RM is started</para>
						</listitem>
						<listitem>
							<para><emphasis>PORT</emphasis> is the protocol dependent port number usually defined by the property <emphasis>proactive.PA_PROTOCOL.port</emphasis>  
							</para>
						</listitem>
					</itemizedlist>
				</listitem>
			</itemizedlist>		
		</para>
		<para>
			The name of the connector (JMXRMAgent by default) is defined by the property <emphasis>rm.jmx.connectorname</emphasis>.
		</para>
		<para>
			The JMX url on which to connect can be obtained from the Authentication API of the RM or by reading the log file
			located in <literal>$RM_HOME/.logs/RM.log</literal>. In that log file, the address you have to retrieve is the one where 
			the JMX RMI connector server has been started:
			<screen>[INFO 2010-06-17 10:23:27,813] [RM.AbstractJMXHelper.boot] Started JMX RMI connector server at service:jmx:rmi:///jndi/rmi://kisscool.inria.fr:5822/JMXRMAgent</screen>
			Once connected, you'll get an access to RM statistics and accounting.
		</para>
		<para>
			For example, to connect to the Resource Manager JMX Agent with the popular JConsole tool, just enter the url of the standard
			RMI Connector as shown on the <xref linkend="jmx_jconsole_connect"/>, as well as the username and the password.
		</para> 			  
			<figure xml:id="jmx_jconsole_connect">
				<info>
					<title>Connection using JConsole</title>
				</info>
				<mediaobject>
					<imageobject>
						<imagedata scalefit="1" width="100%" contentdepth="100%"
							fileref="images/png/jmx_jconsole_connect.png" format="PNG" />
					</imageobject>
				</mediaobject>
			</figure>
		
		<para>
			Then depending on the allowed permissions browse the attributes of the MBeans.
		</para>			  
			<figure xml:id="jmx_jconsole">
				<info>
					<title>Browse MBean attributes</title>
				</info>
				<mediaobject>
					<imageobject>
						<imagedata scalefit="1" width="100%" contentdepth="100%"
							fileref="images/png/jmx_jconsole.png" format="PNG" />
					</imageobject>
				</mediaobject>
			</figure>
					
	</section>

</section>

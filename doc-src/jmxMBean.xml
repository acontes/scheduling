<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/css" href="viewDocbook.css"?>
 <chapter id="JMXMBean">
  
	<title>Existing MBean and JMX notifications in ProActive</title>

	<sect1 id="jmxMBeanPrinciples">
		<title>Principles</title>
		<para>Each ProActive object has an MBean.
			<itemizedlist>
				<listitem>
					<para>ProActiveRuntimeWrapperMBean for a ProActiveRuntimeImpl</para>
				</listitem>
				<listitem>
					<para>NodeWrapperMBean for a NocalNode</para>
				</listitem>
				<listitem>
					<para>BodyWrapperMBean for AbstractBody</para>
				</listitem>
			</itemizedlist>
		</para>
		<para>It is possible to receive the JMX notification emitted by the MBean, or to invoke a method on the MBean.</para>
	</sect1>
 	<sect1 id="subscribeUnsubscribeJMXNotification">
		<title>How to subscribe/unsubscribe to the notifications of a MBean?</title>
		<para>
		Utility classes are provided in order to make easy the subscription of JMX notifications.
		If you subscribe to a MBean of a remote MBean server, this one sends you the notifications of the wanted MBean.
		However, in case of an active object, if the object migrates it is necessary to unsubscribe the listener from the MBean Server and to open a new connection to the new MBean Server and subscribe to this one.
		If you don't do those steps you will not continue to receive the notifications.
		In order to resolve this problem, we provide some classes which do this work:
		<emphasis role="bold">JMXNotificationManager</emphasis> and JMXNotificationListener
		</para>
		<sect2 id="subscribeJMXNotifications">
			<title>Subscribe to the JMX notifications of a ProActive object</title>
<screen>
JMXNotification.getInstance().subscribe(ObjectName objectName, NotificationListener listener, String runtimeUrl);</screen>
			<para><emphasis role="bold">objectName</emphasis> is the identifier of the MBean.</para>
			<para>The FactoryName class gives you some methods in order to get the objectName:
			<itemizedlist>
				<listitem><para>FactoryName.createActiveObjectName(UniqueID id);</para></listitem>
				<listitem><para>FactoryName.createNodeObjectName(String runtimeUrl,String nodeName);</para></listitem>
				<listitem><para>FactoryName.createRuntimeObjectName(String url);</para></listitem>
				<listitem><para>FactoryName.createVirtualNodeObjectName(String vnName,String jobID);</para></listitem>
			</itemizedlist>
			</para>
			<para><emphasis role="bold">listener</emphasis> is a JMX notification listener.(It needs to implement the NotificationListener interface.)</para>
			<para><emphasis role="bold">runtimeUrl</emphasis> The url of the runtime, where to find the MBean.</para>
		</sect2>
		<sect2 id="unsubscribeJMXNotification">
			<title>Unsubscribe to the JMX notifications</title>
			<screen>JMXNotificationManager.getInstance().unsubscribe(ObjectName objectName, NotificationListener listener);</screen>
		</sect2>		
	</sect1>
	<sect1 id="ProActiveJMXNotification">
		<title>The ProActive JMX Notifications</title>
		<sect2 id="sendJMXNotfication">
			<title>How to send a JMX notification?</title>
			<para>
			The classes ProActiveRuntimeImpl, LocalNode, AbstractBody contain a MBean and the <emphasis role="bold">getMBean() </emphasis>method.
			</para>
			<para>
			On the MBean, you can call 2 different methods:
			<itemizedlist>
				<listitem><para>sendNotification(String type);</para></listitem>
				<listitem><para>sendNotification(String type, Object userData);</para></listitem>
			</itemizedlist>
			</para>
			<para>
			<emphasis role="bold">type </emphasis>is the type of the notification.
			The NotificationType class gets a lot of existing notification types.
			</para>
			<para>
			<emphasis role="bold">userData </emphasis>is the object to send to the listener.
			The package <emphasis role="bold">org.objectweb.proactive.core.jmx.notification</emphasis> contains some existing notification.
			</para>
		</sect2>
		<sect2 id="exampleJMXNotificationListener">
			<title>example of notification listener</title>
<screen>
import javax.management.Notification;
import javax.management.NotificationListener;
import org.objectweb.proactive.core.UniqueID;
import org.objectweb.proactive.core.jmx.notification.BodyNotificationData;
import org.objectweb.proactive.core.jmx.notification.NotificationType;

public class MyListener implements NotificationListener{

	public void handleNotification(Notification notification, Object handback){
		// Get the type of the notification
		String type = notification.getType();
		// Get the data of the notification
		Object data  = notification.getUserData();

		if(type.equals(NotificationType.bodyCreated)){
			BodyNotificationData notificationData = (BodyNotificationData) data;
			UniqueID id = notificationData.getId();
			System.out.println("Active Object created with id:"+id);
		}
	}
}</screen>
		</sect2>
		<sect2 id="JMXProActiveNotificationSent">
			<title>The JMX notifications sent by the ProActive MBean</title>
			<sect3 id="ActiveObjectNotifications">
				<title>Notifications sent by the active object MBean.</title>
				<note>
				<title>Warning</title>
				<para>
					For perfomance reasons, the MBean of an active object (BodyWrapperMBean) sends a set of notification.
				</para>
				<para>
				Type of the notification: Notification.setOfNotifications
				</para>
				<para>
				User Data: ConcurrentLinkedQueue&lt;Notification&gt;
				</para>
				</note>
				<para>Migration informations</para>
				<table>
				<title>Migration informations</title>
			    <tgroup cols="2">
				     <tbody>
				      <row>
				       <entry><para><emphasis role="bold">Type of notification</emphasis></para></entry>
				       <entry><para><emphasis role="bold">UserData</emphasis></para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.migrationAboutToStart</para></entry>
				       <entry><para>String (Url of the destination node)</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.migratedBodyRestarted</para></entry>
				       <entry><para>null</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.migrationFinished</para></entry>
				       <entry><para>String (Url of the destination runtime</para></entry>
				      </row>
      
				      <row>
				       <entry><para>Notification.migrationExceptionThrown</para></entry>
				       <entry><para>MigrationException</para></entry>
				      </row>      
				     </tbody>
				    </tgroup>
				   </table>
				   
				   
				<para>Request informations</para>
				   <table>
				<title>Request informationss</title>
			    <tgroup cols="2">
				     <tbody>
				      <row>
				       <entry><para><emphasis role="bold">Type of notification</emphasis></para></entry>
				       <entry><para><emphasis role="bold">UserData</emphasis></para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.requestSent</para></entry>
				       <entry><para>RequestNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.requestReceived</para></entry>
				       <entry><para>RequestNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.replySent</para></entry>
				       <entry><para>null</para></entry>
				      </row>
      
				      <row>
				       <entry><para>Notification.replyReceived</para></entry>
				       <entry><para>null</para></entry>
				      </row>
				      
				       <row>
				       <entry><para>NotificationType.servingStarted</para></entry>
				       <entry><para>Integer (Request queue Size)</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.voidRequestServed</para></entry>
				       <entry><para>Integer (Request queue Size)</para></entry>
				      </row>
				      
      				  <row>
				       <entry><para>NotificationType.waitForRequest</para></entry>
				       <entry><para>null</para></entry>
				      </row>
      
				     </tbody>
				    </tgroup>
				   </table>
				   
				<para>Future informations</para>
				    <table>
				<title>Future informationss</title>
			    <tgroup cols="2">
				     <tbody>
				      <row>
				       <entry><para><emphasis role="bold">Type of notification</emphasis></para></entry>
				       <entry><para><emphasis role="bold">UserData</emphasis></para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.waitByNecessity</para></entry>
				       <entry><para>FutureNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.receivedFutureResult</para></entry>
				       <entry><para>FutureNotificationData</para></entry>
				      </row>
            
				     </tbody>
				    </tgroup>
				   </table>
			</sect3>
			<sect3 id="ProActiveRuntimeJMXNotifications">
				<title>Notifications sent by the ProActiveRuntime</title>
				<para>Creation informations</para>
			<table>
				<title>Creation informations</title>
			    <tgroup cols="2">
				     <tbody>
				      <row>
				       <entry><para><emphasis role="bold">Type of notification</emphasis></para></entry>
				       <entry><para><emphasis role="bold">UserData</emphasis></para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.bodyCreated</para></entry>
				       <entry><para>BodyNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.nodeCreated</para></entry>
				       <entry><para>NodeNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.runtimeRegistered</para></entry>
				       <entry><para>RuntimeNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>Notification.runtimeAcquired</para></entry>
				       <entry><para>RuntimeNotificationData</para></entry>
				      </row>      
				     </tbody>
				    </tgroup>
				   </table>
				   
				<para>Destruction informations</para>
				   <table>
				<title>Destruction informations</title>
			    <tgroup cols="2">
				     <tbody>
				      <row>
				       <entry><para><emphasis role="bold">Type of notification</emphasis></para></entry>
				       <entry><para><emphasis role="bold">UserData</emphasis></para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.bodyDestroyed</para></entry>
				       <entry><para>BodyNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.nodeDestroyed</para></entry>
				       <entry><para>NodeNotificationData</para></entry>
				      </row>
      
				      <row>
				       <entry><para>NotificationType.runtimeDestroyed</para></entry>
				       <entry><para>null</para></entry>
				      </row>
      
				      <row>
				       <entry><para>Notification.runtimeUnregistered</para></entry>
				       <entry><para>RuntimeNotificationData</para></entry>
				      </row>      
				     </tbody>
				    </tgroup>
				   </table>
			</sect3>
		</sect2>
	</sect1>
</chapter>
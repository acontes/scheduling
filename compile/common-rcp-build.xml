<project>

	<property file="rcp.build.properties" />

	<macrodef name="run-rcp-build">
		<attribute name="productFile" />
		<attribute name="distDir" default="dist" />
		<sequential>
			<available type="dir" file="${eclipse.baseLocation}"
				property="eclipse.baseLocation.exists" />
			<fail
				message="Could not find the installation directory of eclipse. Please set the variable 'eclipse.baseLocation' with the path of your eclipse installation"
				unless="eclipse.baseLocation.exists" />

			<property name="equinoxjar_regexp" value="plugins/org.eclipse.equinox.launcher_*.jar" />
			<path id="equinox-id-file">
				<fileset dir="${eclipse.baseLocation}">
					<include name="${equinoxjar_regexp}" />
				</fileset>
			</path>
			<property name="equinoxjar" refid="equinox-id-file" />

			<available type="file" file="${equinoxjar}" property="equinoxjar.exists" />
			<fail
				message="Could not find the equinox.launcher jar using regexp '${eclipse.baseLocation}/${equinoxjar_regexp}'"
				unless="equinoxjar.exists" />

			<available property="haveDeltaPack" file="${deltapack}" />
			<fail unless="haveDeltaPack"
				message="The deltapack is required to build this product. Please set the 'deltapack' property." />

			<java jar="${equinoxjar}" fork="true" failonerror="true">
				<arg value="-application" />
				<arg value="org.eclipse.ant.core.antRunner" />
				<arg value="-buildfile" />
				<arg value="common-rcp-build.xml" />
				<arg value="rcp-build" />
				<jvmarg value="-DbaseLocation=${eclipse.baseLocation}" />
				<jvmarg value="-Dproduct=@{productFile}" />
				<jvmarg value="-DbuildProductName=@{productName}" />
				<jvmarg value="-DdistDir=@{distDir}" />
			</java>
		</sequential>
	</macrodef>

	<!-- this target is invoked by the 'run-rcp-build' macrodef via the equinox launcher -->
	<target name="rcp-build">
		<property name="buildDirectory" value="${basedir}/tmpBuildDir" />

		<delete dir="${buildDirectory}" />

		<property name="p2.gathering" value="true" />
		<property name="runPackager" value="true" />
		
		<property name="buildNamePrefix" value="Scheduling-11.22.33-RCP" />
		<property name="archiveNamePrefix" value="${buildNamePrefix}" />
        <property name="archivePrefix" value="${buildNamePrefix}" />
		<property name="collectingFolder" value="${archivePrefix}" />
		<property name="buildType" value="" />
		<property name="buildId" value="${buildNamePrefix}" />
		<property name="buildLabel" value="${buildType}.${buildId}" />
		<property name="timestamp" value="007" />
		
		<property name="allowBinaryCycles" value="true" />
		<property name="flattenDependencies" value="true" />
		<property name="filteredDependencyCheck" value="false" />
		<property name="resolution.devMode" value="false" />
		
		<property name="skipBase" value="true" />
		<property name="skipMaps" value="true" />
		<property name="skipFetch" value="true" />
		
		<property name="logExtension" value=".log" />
		<property name="javacDebugInfo" value="false" />
		<property name="javacFailOnError" value="true" />
		<property name="javacVerbose" value="false" />
		<property name="javacSource" value="1.6" />
		<property name="javacTarget" value="1.6" />
		
		<property name="builder" value="${basedir}" />
		<property name="buildDirectory" value="${basedir}/buildDirectory" />
		<property name="buildTempFolder" value="${buildDirectory}" />
		<property name="pluginPath" value="${rcp.pluginPath}${path.separator}${deltapack}" />

		<ant antfile="${eclipse.pdebuild.scripts}/productBuild/productBuild.xml" />

		<mkdir dir="${buildDirectory}" />
		<mkdir dir="${distDir}" />

		<move todir="${distDir}">
			<fileset dir="${buildDirectory}/${buildLabel}" includes="*.zip,*.tar.gz" />
		</move>

		<delete dir="${buildDirectory}" />
	</target>

</project>

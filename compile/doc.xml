<?xml version="1.0" encoding="UTF-8"?>
<project name="ProActive Documentation" basedir=".">
	
	<import file="common.xml" />
	
	<!-- ================================================================ -->
		<!--            Create docs, which is the javadoc + manual            -->
		<!--  =============================================================== -->
		<target name="docs" depends="javadoc.published, manual, java2html" description="Construct the javadoc and the manual" />
	
		<!-- ================================================================ -->
		<!--            Make the java files readable on the web               -->
		<!--  =============================================================== -->
		<!-- 
			** Do not support Java 1.5 **
		<target name="java2html">
			<echo message="Converting java to html..." />
			<java jar="${base}/dev/lib/j2h.jar" fork="true">
				<arg line="-d ${docs.dir}/ProActive_src_html" />
				<arg line="-js ${src.dir}/${proactive.dir}" />
				<arg line="-jd ${docs.dir}/api http://www-sop.inria.fr/oasis/ProActive/doc/api" />
				<arg line="-t 2 -n '${name} source code'" />
			</java>

		</target>-->

		<!-- TODO tempory fix for java 1.5, do not generate index.html -->
		<!-- http://www.java2html.de /dev/lib/j2h.jar -->
		<target name="java2html">
			<taskdef name="j2h" classname="de.java2html.anttasks.Java2HtmlTask" classpath="${base.dir}/dev/lib/j2h.jar" />
			<j2h srcdir="${src.proactive.dir}" destdir="${docs.dir}/ProActive_src_html" includes="**/*.java" style="eclipse" showLineNumbers="false" showFileName="true" showTableBorder="false" useshortfilename="false" outputFormat="html" />
			<j2h srcdir="${src.examples.dir}" destdir="${docs.dir}/ProActive_src_html" includes="**/*.java" style="eclipse" showLineNumbers="false" showFileName="true" showTableBorder="false" useshortfilename="false" outputFormat="html" />
		</target>


		<!-- ================================================================ -->
		<!--                     Create javadoc                               -->
		<!-- ================================================================ -->
		<target name="javadoc.all" depends="javadoc.published,javadoc.complete"/>


		<target name="javadoc.complete"  description="Make complete Javadoc">
			<javadoc  
				destdir="${docs.dir}/api.complete" 
				author="true" 
				version="true" 
				source="${source}" 
				use="true" 
				windowtitle="Scheduler complete API" 
				breakiterator="yes" 
				additionalparam="-docfilessubdirs -excludedocfilessubdir CVS:test_documentation"> 

				<classpath>
						<path refid="compile.libs"/>
						<pathelement path="${cl.scheduler.dir}"/>
						<pathelement path="${cl.extensions.dir}"/>
				</classpath>

				<packageset dir="${src.scheduler.dir}" />
				<packageset dir="${src.extensions.dir}" />
				<packageset dir="${src.extra.dir}" />

				<link href="http://fractal.objectweb.org/current/doc/javadoc/fractal/" />
				<link href="http://java.sun.com/j2se/1.5.0/docs/api/"/>
				<doctitle><![CDATA[Scheduler ${version}<br><a href='../html/index.html'>(documentation is here)</a><br>]]></doctitle>
				<bottom><![CDATA[<i>Copyright 1997-2007 INRIA All Rights Reserved.</i>]]></bottom>
	
				<group title="Scheduler packages for end user" packages="org.objectweb.scheduler" />
				<group title="Scheduler Core" packages="org.objectweb.scheduler.core*" />
				<group title="Scheduler Core : Body" packages="org.objectweb.Scheduler.core.body*" />
				<group title="Scheduler Core : Components (implementation of the Fractal model)" packages="org.objectweb.Scheduler.core.component*" />
				<group title="Scheduler P2P : P2P infrastructure" packages="org.objectweb.Scheduler.extra.p2p*" />
				<group title="Scheduler Extensions : Security" packages="org.objectweb.Scheduler.ext.security*" />
				<group title="Scheduler Extensions" packages="org.objectweb.Scheduler.ext*" />
				<group title="Scheduler Branch and Bound API" packages="org.objectweb.Scheduler.branchnbound*" />
				<group title="Scheduler Calcium API" packages="org.objectweb.Scheduler.calcium*" />
				<group title="Scheduler Load Balancing API" packages="org.objectweb.Scheduler.loadbalancing*" />
				<group title="Scheduler MPI API" packages="org.objectweb.Scheduler.mpi*" />
				<group title="Scheduler OSGI API" packages="org.objectweb.Scheduler.osgi*" />
				<group title="Scheduler JMX API" packages="org.objectweb.Scheduler.jmx*" />
				<group title="Scheduler Scheduler API" packages="org.objectweb.Scheduler.scheduler*" />
				<group title="Scheduler Benchmarks API" packages="org.objectweb.Scheduler.benchmarks*" />
					
				
			</javadoc>			
		</target>
	
		<target name="javadoc.published"  description="Make published Javadoc">
			
			<javadoc source="${source}"	classpathref="compile.libs">
				<doclet name="doc.PublishedAPIDoclet" path="${cl.utils.dir}">
					<param name="-file" value="${compile.dir}/publishedCoreClasses" />
				</doclet>
				<packageset dir="${src.scheduler.dir}"/>
			</javadoc>
			
			<javadoc source="${source}">
				<classpath>
					<path refid="compile.libs"/>
					<pathelement path="${cl.scheduler.dir}"/>
				</classpath>
				<doclet name="doc.PublishedAPIDoclet" path="${cl.utils.dir}">
					<param name="-file" value="${compile.dir}/publishedExtensionsClasses" />
				</doclet>
				<packageset dir="${src.extensions.dir}"/>
			</javadoc>
						
			<javadoc source="${source}">
				<classpath>
						<path refid="compile.libs"/>
						<pathelement path="${cl.scheduler.dir}"/>
						<pathelement path="${cl.extensions.dir}"/>
				</classpath>
				<doclet name="doc.PublishedAPIDoclet" path="${cl.utils.dir}">
					<param name="-file" value="${compile.dir}/publishedExtraClasses" />
				</doclet>
				<packageset dir="${src.extra.dir}"/>
			</javadoc>
						
			<javadoc  
				destdir="${docs.dir}/api" 
				author="true" 
				version="true" 
				source="${source}" 
				use="true" 
				windowtitle="Scheduler API" 
				breakiterator="yes" 
				additionalparam="-docfilessubdirs -excludedocfilessubdir CVS:test_documentation"> 

				<classpath>
						<path refid="compile.libs"/>
						<pathelement path="${cl.scheduler.dir}"/>
						<pathelement path="${cl.extensions.dir}"/>
				</classpath>

				
				<fileset dir="${src.scheduler.dir}" includesfile="${compile.dir}/publishedCoreClasses"/>
				<fileset dir="${src.extensions.dir}" includesfile="${compile.dir}/publishedExtensionsClasses"/>
				<fileset dir="${src.extra.dir}" includesfile="${compile.dir}/publishedExtraClasses"/>

				<link href="http://fractal.objectweb.org/current/doc/javadoc/fractal/" />
				<link href="http://java.sun.com/j2se/1.5.0/docs/api/"/>
				<doctitle><![CDATA[Scheduler ${version}<br><a href='../html/index.html'>(documentation is here)</a><br>]]></doctitle>
				<bottom><![CDATA[<i>Copyright 1997-2007 INRIA All Rights Reserved.</i>]]></bottom>
				
				<group title="Scheduler entry point">
					<package name="org.objectweb.scheduler.api" />
				</group>
					
				<group title="Scheduler Core">
					<package name="org.objectweb.scheduler.core*" />
					<package name="org.objectweb.scheduler.filetransfer*" />
					<package name="org.objectweb.scheduler.ext.*" />
					<package name="org.objectweb.scheduler.mpi" />
					<package name="org.objectweb.scheduler.benchmarks.*" />
					<package name="org.objectweb.scheduler.extra.p2p.*" />
					<package name="org.objectweb.scheduler" />
					<package name="org.objectweb.scheduler.annotation" />
				</group>
								
				<group title="Scheduler Extensions">
					<package name="org.objectweb.scheduler.extensions*" />
				</group>
							
				<group title="Scheduler Extra">
					<package name="org.objectweb.scheduler.extra*" />
				</group>
				
			</javadoc>			
		</target>

	<!-- ==================================================================== -->
	<!--      The following docbook* are sub-tasks to build the Manual        -->
	<!-- ==================================================================== -->
	<!-- If a needed file doesn't exist, it will be fetched on the web -->	
	<xmlcatalog id="docbookcatalog">
			<!-- If a needed file doesn't exist, it will be fetched on the web -->

			<classpath>
				<!-- Here are some possible paths for the xsl stylesheets, which are contained in docbook-xsl-${docbook.version}.zip-->
				<pathelement location="${base.dir}/dev/lib/docbook/docbook-xsl-${docbook.version}.zip" />
			</classpath>

			<dtd publicId="-//OASIS//DTD DocBook XML V5.0//EN" location="../doc-src/docbook.dtd" />
			<dtd publicId="http://www.oasis-open.org/docbook/xml/5.0b5/dtd/docbook.dtd"  location="../doc-src/docbook.dtd"/>

			<entity publicid="http://docbook.sourceforge.net/release/xsl/${docbook.version}/profiling/profile.xsl" location="docbook-xsl-${docbook.version}/profiling/profile.xsl" />
			<entity publicid="http://docbook.sourceforge.net/release/xsl/${docbook.version}/html/chunk.xsl" location="docbook-xsl-${docbook.version}/html/chunk.xsl" />
			<entity publicid="http://docbook.sourceforge.net/release/xsl/${docbook.version}/html/docbook.xsl" location="docbook-xsl-${docbook.version}/html/docbook.xsl" />
			<entity publicid="http://docbook.sourceforge.net/release/xsl/${docbook.version}/fo/docbook.xsl" location="docbook-xsl-${docbook.version}/fo/docbook.xsl" />
		</xmlcatalog>

	
	


	<!-- ==================================================================== -->
	<!--      Converts docbook xml into ??? - uses the trax processor         -->
	<!-- ==================================================================== -->
	<target name="-docbookTransform"	>
		<!-- Profiling step: keep only the tags which have the attribute os="${docbook.profile}" or no os attribute -->
		<xslt basedir="${doc.src}" processor="trax" in="${docs.tmp.dir}/${docbookInputFile}" out="${docs.tmp.dir}/profiled.xml" style="${doc.src}/xsl/profiling.xsl" force="yes">
			<param name="profile.os" expression="${docbook.profile}" />
			<!--docbook.profile can be html, pdf or empty-->
			<xmlcatalog refid="docbookcatalog" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir="${base.dir}/dev/lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</xslt>

		<!-- Do the real conversion, docbook to pdf or html -->
		<xslt basedir="${doc.src}" processor="trax" in="${docs.tmp.dir}/profiled.xml" out="${docbookOutputFile}" style="${docbookStyle}" force="yes">
			<xmlcatalog refid="docbookcatalog" />
			<param name="TODAY" expression="${TODAY}" />
			<!-- the date for the first page -->
			<param name="VERSION" expression="${version}" />
			<!-- the version number, for the first page -->
			<classpath>
				<fileset dir="${base.dir}/dev/lib/docbook/">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</xslt>
	</target>


	<!-- ==================================================================== -->
	<!--          Generic task to transform docbook xml into pdf              -->
	<!-- ==================================================================== -->
	<target name="-docbookToPdf">
		<property name="fo.output" value="${pdfOutputFile}.fo" />

		<!--   First translate into intermediate fo format -->
		<antcall target="-docbookTransform">
			<param name="docbookOutputFile" value="${fo.output}" />
			<param name="docbookStyle" value="${doc.src}/xsl/pdf.xsl" />
			<param name="docbook.profile" value="pdf" />
		</antcall>

		<!-- declare how to transform fo xml file in pdf through a new 'fop' task -->
		<taskdef name="fop" classname="org.apache.fop.tools.anttasks.Fop" description="Official way to translate .fo (result of xml docbook translation) into .pdf">
			<classpath>
				<fileset dir="${base.dir}/dev/lib/docbook/">
					<include name="*.jar" />
				</fileset>
				
			</classpath>
		</taskdef>

		<!-- Then use the newly defined fop task to translate fo into pdf -->
		<fop format="application/pdf" fofile="${fo.output}" outfile="${pdfOutputFile}" basedir="${doc.src}" />

		<delete file="${fo.output}" />
	</target>


	<!-- ==================================================================== -->
	<!--          Create the snippets necessary for programlistings           -->
	<!-- ==================================================================== -->
	<target name="-snippetscreation" >
		<delete quiet="true">
			<fileset dir="${snippets.location}"/>
		</delete>
		<mkdir dir="${snippets.location}"/>
		<java classname="doc.snippets.Snippetizer" fork="true">
			<classpath refid="scheduler.libs"/>
			<!-- The root for parser start, it will check all the files in the dir and subdirs-->
			<arg value="${base.dir}" />
			<!-- The output path for snippets  -->
			<arg value="${snippets.location}" />
			
		</java>
		<eclipse_format_m>
				<sourcefileset>
					<fileset dir="${snippets.location}" includes="**/*.snip" />
				</sourcefileset>
		</eclipse_format_m>
	</target>
	
	
	
	<!-- ==================================================================== -->
	<!--    Add some highlighting information to the docbook source code      -->
	<!-- ==================================================================== -->
	<target name="-docbookBeautify" >
		
		<java classname="doc.DocBookize" fork="true">
			<classpath refid="scheduler.libs"/>
			<!-- The xml file to parse -->
			<arg value="${docs.tmp.dir}/${docbookInputFile}" />
			<!-- The path to find java files in html -->
			<arg value="Scheduler_src_html/${scheduler.path}/" />
			
			<!-- the path for java file inclusion -->
			<arg value="${src.scheduler.dir}/${scheduler.path}/" />
			<arg value="${src.examples.dir}/${scheduler.path}/" />
			
			<!-- the path for xml file inclusion -->
			<arg value="${descriptors.dir}/" />
			
		</java>

		<java classname="doc.Validate" fork="true">
			<classpath refid="scheduler.libs" />
			<classpath>
				<fileset dir="${base.dir}/dev/lib/docbook/">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${docs.tmp.dir}/${docbookInputFile}" />
		</java>

	</target>


	<!-- ==================================================================== -->
	<!-- preprocessing for the manual: copy files and add tags to source code -->
	<!-- ==================================================================== -->
	<target name="-docbookPreProcess">

		<!-- as this file gets edited, make sure it's a fresh copy-->
		<delete file="${docs.tmp.dir}/${docs.mainFile}" />

		<!-- Copy the files needed for the html files (pics and maybe others) -->
		<copy toDir="${docs.dir}/html/">
			<fileset dir="${doc.src}">
				<include name="**/*.png" />
				<include name="**/*.jpg" />
				<include name="Scheduler.css" />
			</fileset>
		</copy>

		<!-- Copying xml files so they can be edited (beautify programlistings) -->
		<copy toDir="${docs.tmp.dir}" includeemptydirs="no">
			<fileset dir="${doc.src}">
				<include name="**/*" />
				<exclude name="**/.svn" />
				<exclude name="xsl" />
			</fileset>
		</copy>

		<!-- Call the code for generating the snippets -->
		<antcall target="-snippetscreation"/>

		<!-- Decorate the code a bit (code examples in programlistings) -->
		<antcall target="-docbookBeautify">
			<param name="docbookInputFile" value="${docs.mainFile}" />
		</antcall>

	</target>


	<!-- ==================================================================== -->
	<!--          Make just the html files for the manual                     -->
	<!-- ==================================================================== -->
	<target name="manualHtml" description="Make only the html files in the manual" depends="-docbookPreProcess">
		<antcall target="-docbookTransform">
			<param name="docbookInputFile" value="${docs.mainFile}" />
			<param name="docbookOutputFile" value="${docs.dir}/html/index.html" />
			<param name="docbookStyle" value="${doc.src}/xsl/chunkedhtml.xsl" />
			<param name="docbook.profile" value="html" />
		</antcall>
		<zip destfile="${docs.dir}/SchedulerManualMultipleHtml.zip" basedir="${docs.dir}/html" excludes="SchedulerManual.html"/>
	</target>

	<!-- ==================================================================== -->
	<!--               Make just the pdf files for the manual                 -->
	<!-- ==================================================================== -->
	<target name="manualPdf" description="Make only the pdf files in the manual" depends="-docbookPreProcess">
		<antcall target="-docbookToPdf">
			<param name="docbookInputFile" value="${docs.mainFile}" />
			<param name="pdfOutputFile" value="${docs.dir}/pdf/SchedulerManual.pdf" />
		</antcall>
		<zip destfile="${docs.dir}/SchedulerManualPdf.zip" basedir="${docs.dir}/pdf" includes="SchedulerManual.pdf"/>
	</target>


	<!-- ==================================================================== -->
	<!--           Make only one huge html-file from the doc                  -->
	<!-- ==================================================================== -->
	<target name="manualSingleHtml" description="Make only the big html file in the manual" depends="-docbookPreProcess">
		<antcall target="-docbookTransform">
			<param name="docbookInputFile" value="${docs.mainFile}" />
			<param name="docbookOutputFile" value="${docs.dir}/html/SchedulerManual.html" />
			<param name="docbookStyle" value="${doc.src}/xsl/onehtml.xsl" />
			<param name="docbook.profile" value="html" />
		</antcall>
		<zip destfile="${docs.dir}/SchedulerManualSingleHtml.zip" basedir="${docs.dir}/html" includes="SchedulerManual.html **/*.gif **/*.png **/*.jpg"/>
	</target>


	<!-- ==================================================================== -->
	<!-- Construct the manual from the XML files in {docs.src}                -->
	<!-- ==================================================================== -->
	<target name="manual" description="Build all the different manual version: html, pdf... " depends="manualSingleHtml,manualHtml,manualPdf">
		<!-- The generation of the files is done by the depends clause -->
		<!-- Once the doc files have been generated, do some cleaning up -->
		<delete dir="${docs.tmp.dir}" />
		<copy todir="${docs.dir}/examples">
			<!-- XML descriptor examples also available -->
			<fileset dir="${base.dir}/descriptors/examples" />
		</copy>
	</target>

			
</project>
